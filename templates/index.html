<!DOCTYPE html>
<html>
  <head>
    <title>AI Search Assignment</title>
    <script
      type="text/javascript"
      src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"
    ></script>

    <style>
      /* --- 1. LAYOUT & THEME --- */
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        background-color: #f0f2f5;
        color: #333;
        display: flex;
        flex-direction: column; /* Changed to Column to stack Header + Content */
        height: 100vh;
        overflow: hidden;
      }

      /* --- 2. TOP HEADER --- */
      .top-header {
        /* background-color: #2c3e50; */
        color: #007bff;
        padding: 15px 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 20;
        display: flex;
        align-items: center;
        text-align: center;
      }
      .top-header h1 {
        font-size: 1.4rem;
        font-weight: 600;
      }

      /* --- 3. APP CONTAINER (Sidebars + Graph) --- */
      .app-container {
        display: flex;
        flex-grow: 1;
        overflow: hidden; /* Contains the scrollbars inside sections */
      }

      /* --- 4. LEFT SIDEBAR (CONTROLS) --- */
      .left-sidebar {
        width: 300px;
        min-width: 300px;
        background-color: white;
        padding: 20px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        border-right: 1px solid #e0e0e0;
        z-index: 10;
      }

      .left-sidebar h2 {
        margin-top: 0;
        font-size: 1.1rem;
        color: #444;
        border-bottom: 2px solid #f0f2f5;
        padding-bottom: 10px;
      }
      .left-sidebar label {
        font-size: 0.9rem;
        margin-bottom: 5px;
        display: block;
        font-weight: 600;
        color: #555;
      }

      .left-sidebar input,
      .left-sidebar select {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
        background-color: #fafafa;
        color: #333;
      }

      /* Dynamic Row Styling */
      .connection-row {
        display: flex;
        gap: 5px;
        margin-bottom: 5px;
      }
      .connection-row select {
        flex: 2;
        margin-bottom: 0;
      } /* Neighbor is now SELECT */
      .connection-row input {
        flex: 1;
        margin-bottom: 0;
      } /* Cost is INPUT */

      button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
        margin-top: 5px;
      }
      .btn-run {
        background-color: #007bff;
        color: white;
        margin-bottom: 10px;
      }
      .btn-run:hover {
        background-color: #0056b3;
      }
      .btn-add {
        background-color: #007bff;
        color: white;
        margin-top: 15px;
      }
      .btn-add:hover {
        background-color: #0056b3;
      }
      .btn-small {
        background-color: #e2e6ea;
        color: #555;
        font-size: 0.85rem;
        padding: 8px;
        margin-top: 0;
      }
      .btn-small:hover {
        background-color: #dbe0e5;
        color: #333;
      }

      /* --- 5. MAIN CONTENT (GRAPH) --- */
      .main-content {
        flex-grow: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        background-color: #f0f2f5;
      }

      #network {
        width: 100%;
        height: 100%;
        min-height: 500px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid #e0e0e0;
      }

      /* --- 6. RIGHT SIDEBAR (RESULTS) --- */
      .right-sidebar {
        width: 250px;
        min-width: 250px;
        background-color: white;
        padding: 20px;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
        border-left: 1px solid #e0e0e0;
        overflow-y: auto;
        z-index: 10;
      }

      .right-sidebar h2 {
        margin-top: 0;
        font-size: 1.1rem;
        color: #444;
        border-bottom: 2px solid #f0f2f5;
        padding-bottom: 10px;
      }

      .result-box {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .result-metric {
        margin-bottom: 10px;
        font-size: 0.95rem;
      }
      .result-metric span {
        font-weight: bold;
        color: #007bff;
      }

      .path-list {
        padding-left: 20px;
        margin: 5px 0;
        color: #555;
      }
      .path-list li {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="top-header">
      <h1>AI Search Assignment</h1>
    </div>

    <div class="app-container">
      <div class="left-sidebar">
        <div>
          <h2>1. Search Settings</h2>
          <label>Start City</label>
          <select id="start"></select>

          <label>Goal City</label>
          <select id="goal"></select>

          <label>Algorithm</label>
          <select id="algo">
            <option value="BFS">Breadth-First (BFS)</option>
            <option value="DFS">Depth-First (DFS)</option>
            <option value="UCS">Uniform Cost (UCS)</option>
          </select>
          <button class="btn-run" onclick="runAlgo()">
            Run Search Algorithm
          </button>
        </div>

        <div style="margin-top: 30px">
          <h2>2. Add New Road</h2>
          <label>New/Existing City Name</label>
          <input id="newNode" placeholder="e.g., Daska" />

          <label>Connections (Neighbor & Cost)</label>
          <div id="connectionsContainer"></div>

          <button class="btn-small" onclick="addConnectionRow()">
            + Add Another Link
          </button>
          <button class="btn-add" onclick="saveNode()">
            Save Node & Links
          </button>
        </div>
      </div>

      <div class="main-content">
        <div id="network"></div>
      </div>

      <div class="right-sidebar">
        <h2>Search Results</h2>
        <div id="resultContainer" style="display: none">
          <div class="result-box">
            <div class="result-metric">
              Algorithm: <span id="resAlgo">-</span>
            </div>
            <div class="result-metric">
              Total Cost: <span id="resCost">-</span>
            </div>
            <div class="result-metric">
              Time (Steps): <span id="resSteps">-</span>
            </div>
          </div>

          <label>Path Taken:</label>
          <ol id="resPath" class="path-list"></ol>
        </div>
        <div
          id="resultPlaceholder"
          style="color: #999; text-align: center; margin-top: 50px"
        >
          Run an algorithm to see results here.
        </div>
      </div>
    </div>

    <script type="text/javascript">
      // --- 0. SAFETY CHECK ---
      if (typeof vis === "undefined") {
        alert(
          "Error: Vis.js library could not load. Please check your internet connection."
        );
      }

      // --- 1. INITIAL DATA ---
      let nodesArray = [
        { id: "Arad", label: "Arad" },
        { id: "Zerind", label: "Zerind" },
        { id: "Oradea", label: "Oradea" },
        { id: "Sibiu", label: "Sibiu" },
        { id: "Timisoara", label: "Timisoara" },
        { id: "Lugoj", label: "Lugoj" },
        { id: "Mehadia", label: "Mehadia" },
        { id: "Drobeta", label: "Drobeta" },
        { id: "Craiova", label: "Craiova" },
        { id: "Rimnicu Vilcea", label: "Rimnicu" },
        { id: "Fagaras", label: "Fagaras" },
        { id: "Pitesti", label: "Pitesti" },
        { id: "Bucharest", label: "Bucharest" },
        { id: "Giurgiu", label: "Giurgiu" },
        { id: "Urziceni", label: "Urziceni" },
        { id: "Hirsova", label: "Hirsova" },
        { id: "Eforie", label: "Eforie" },
        { id: "Vaslui", label: "Vaslui" },
        { id: "Iasi", label: "Iasi" },
        { id: "Neamt", label: "Neamt" },
      ];

      let edgesArray = [
        { from: "Arad", to: "Zerind", label: "75" },
        { from: "Arad", to: "Sibiu", label: "140" },
        { from: "Arad", to: "Timisoara", label: "118" },
        { from: "Zerind", to: "Oradea", label: "71" },
        { from: "Oradea", to: "Sibiu", label: "151" },
        { from: "Sibiu", to: "Fagaras", label: "99" },
        { from: "Sibiu", to: "Rimnicu Vilcea", label: "80" },
        { from: "Timisoara", to: "Lugoj", label: "111" },
        { from: "Lugoj", to: "Mehadia", label: "70" },
        { from: "Mehadia", to: "Drobeta", label: "75" },
        { from: "Drobeta", to: "Craiova", label: "120" },
        { from: "Craiova", to: "Rimnicu Vilcea", label: "146" },
        { from: "Craiova", to: "Pitesti", label: "138" },
        { from: "Rimnicu Vilcea", to: "Pitesti", label: "97" },
        { from: "Fagaras", to: "Bucharest", label: "211" },
        { from: "Pitesti", to: "Bucharest", label: "101" },
        { from: "Bucharest", to: "Giurgiu", label: "90" },
        { from: "Bucharest", to: "Urziceni", label: "85" },
        { from: "Urziceni", to: "Hirsova", label: "98" },
        { from: "Urziceni", to: "Vaslui", label: "142" },
        { from: "Hirsova", to: "Eforie", label: "86" },
        { from: "Vaslui", to: "Iasi", label: "92" },
        { from: "Iasi", to: "Neamt", label: "87" },
      ];

      // --- 2. DRAW GRAPH ---
      const nodes = new vis.DataSet(nodesArray);
      const edges = new vis.DataSet(edgesArray);
      const container = document.getElementById("network");

      const data = { nodes: nodes, edges: edges };
      const options = {
        physics: { enabled: true, stabilization: { iterations: 100 } },
        edges: { font: { align: "top" } },
      };

      const network = new vis.Network(container, data, options);

      // --- 3. HELPER: Generate Options for Dropdowns ---
      function getCityOptionsHTML() {
        const allNodes = nodes.get().sort((a, b) => a.id.localeCompare(b.id));
        let html = "";
        allNodes.forEach((node) => {
          html += `<option value="${node.id}">${node.label}</option>`;
        });
        return html;
      }

      // --- 4. POPULATE DROPDOWNS (Main Search + Neighbors) ---
      function updateAllDropdowns() {
        // 1. Update Search Start/Goal
        const startSelect = document.getElementById("start");
        const goalSelect = document.getElementById("goal");
        const currentStart = startSelect.value || "Arad";
        const currentGoal = goalSelect.value || "Bucharest";

        const optionsHTML = getCityOptionsHTML();
        startSelect.innerHTML = optionsHTML;
        goalSelect.innerHTML = optionsHTML;

        // Restore selection if possible
        startSelect.value = currentStart;
        goalSelect.value = currentGoal;

        // 2. Update Any Existing Connection Rows (Optional, but good UX)
        // (If you want to live-update current rows, you'd loop through them here)
      }

      // --- 5. LOGIC: ADD CONNECTION ROW ---
      function addConnectionRow() {
        const container = document.getElementById("connectionsContainer");
        const div = document.createElement("div");
        div.className = "connection-row";

        // USE DROPDOWN FOR NEIGHBOR
        div.innerHTML = `
                <select class="conn-neighbor">
                    ${getCityOptionsHTML()}
                </select>
                <input type="number" placeholder="Cost" class="conn-cost">
            `;
        container.appendChild(div);
      }

      // Initialize on Load
      updateAllDropdowns();
      addConnectionRow(); // Add the first row by default

      // --- 6. LOGIC: SAVE NODE ---
      async function saveNode() {
        const newNode = document.getElementById("newNode").value.trim();
        if (!newNode) {
          alert("Please enter a City Name");
          return;
        }

        const neighbors = document.getElementsByClassName("conn-neighbor");
        const costs = document.getElementsByClassName("conn-cost");
        let connectionsList = [];

        for (let i = 0; i < neighbors.length; i++) {
          let nVal = neighbors[i].value; // Value from Dropdown
          let cVal = costs[i].value.trim();
          if (nVal && cVal)
            connectionsList.push({ neighbor: nVal, cost: cVal });
        }

        if (connectionsList.length === 0) {
          alert("Please add at least one connection.");
          return;
        }

        const response = await fetch("/add_node", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ node: newNode, connections: connectionsList }),
        });

        const resData = await response.json();

        if (resData.status === "success") {
          try {
            nodes.add({ id: newNode, label: newNode });
          } catch (e) {}
          connectionsList.forEach((conn) => {
            try {
              nodes.add({ id: conn.neighbor, label: conn.neighbor });
            } catch (e) {}
            edges.add({ from: newNode, to: conn.neighbor, label: conn.cost });
          });

          document.getElementById("newNode").value = "";
          document.getElementById("connectionsContainer").innerHTML = ""; // Clear rows

          updateAllDropdowns(); // Refresh dropdowns with new city
          addConnectionRow(); // Add a fresh row

          alert("Node Added!");
        } else {
          alert("Error adding node.");
        }
      }

      // --- 7. LOGIC: RUN ALGORITHM ---
      async function runAlgo() {
        const start = document.getElementById("start").value;
        const goal = document.getElementById("goal").value;
        const algo = document.getElementById("algo").value;

        const response = await fetch("/solve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ start, goal, algo }),
        });

        const resData = await response.json();

        if (resData.path.length > 0) {
          document.getElementById("resultContainer").style.display = "block";
          document.getElementById("resultPlaceholder").style.display = "none";

          document.getElementById("resAlgo").innerText = algo;
          document.getElementById("resCost").innerText = resData.cost;
          document.getElementById("resSteps").innerText = resData.steps;

          const pathList = document.getElementById("resPath");
          pathList.innerHTML = "";
          resData.path.forEach((city) => {
            let li = document.createElement("li");
            li.innerText = city;
            pathList.appendChild(li);
          });

          nodes.forEach((node) =>
            nodes.update({ id: node.id, color: null, font: { color: "black" } })
          );
          resData.path.forEach((id) => {
            nodes.update({
              id: id,
              color: { background: "#007bff", border: "#0056b3" },
              font: { color: "white" },
            });
          });
        } else {
          alert("No path found!");
        }
      }
    </script>
  </body>
</html>
